<!-- Course overview -->
<div class="panel panel-white" id="box_creer_rapport" style="display: none">
    <div class="panel-heading">
       <h6 class="panel-title text-semibold">Informations</h6>
       <div class="heading-elements">
          <ul class="list-inline list-inline-separate heading-text">
             <li>Réf : <span class="label_info"></span></li>
          </ul>
          <ul class="icons-list">
             <li><a data-action="collapse"></a></li>
          </ul>
       </div>
    </div>
    <ul class="nav nav-lg nav-tabs nav-tabs-bottom nav-tabs-toolbar no-margin">
       <li class="active"><a href="#box_client" data-toggle="tab"><i class="icon-menu7 position-left"></i>Client</a></li>
       <li><a href="#situationJuridique" data-toggle="tab"><i class="icon-notebook position-left"></i>Situation juridique</a></li>
       <li><a href="#modal_description" data-toggle="tab"><i class="icon-notebook position-left"></i>Description</a></li>
       <li><a href="#photos" data-toggle="tab"><i class="icon-notebook position-left"></i>Photos</a></li>
       <li><a href="#commentaire" data-toggle="tab"><i class="icon-notebook position-left"></i>Commentaire</a></li>
       <li><a href="#annexes" data-toggle="tab"><i class="icon-notebook position-left"></i>Annexes</a></li>
       <li><a href="#autorisation" data-toggle="tab"><i class=" icon-files-empty position-left"></i>Autorisation</a></li>
       <li><a href="#tab_evaluer" data-toggle="tab"><i class="icon-menu7 position-left"></i> Evaluer</a></li>
    </ul>
    <!--Unchecked switch--------------------------------------> 
    <div class="tab-content">
       {% include 'my_map/gestion_rapports/box_situation_juridique.html' %}
       {% include 'my_map/gestion_rapports/box_description.html' %}
       {% include 'my_map/gestion_rapports/box_annexes.html' %}
       {% include 'my_map/gestion_rapports/box_autorisations.html' %}
       {% include 'my_map/gestion_rapports/box_commentaire.html' %}
       {% include 'my_map/gestion_rapports/box_client.html' %}
       {% include 'my_map/gestion_rapports/box_photos.html' %}
       {% include 'my_map/gestion_rapports/tab_evaluer.html' %}
    </div>
    <!-- /course overview -->
 </div>
 <!-- Course overview -->
 <script>
   var rapport = 0;
   var map_approximation = new L.map('map_approximation').setView([51.505, -0.09], 12);;
   function create_rapport(lat, lng){
      fetch('http://127.0.0.1:8000/rapport/createRapport/?lat='+lat+'&lng='+lng)
      .then((resp) => resp.json())
      .then(function(data) {
         if(data.id != null ) {
            console.log(data)
            rapport = data.id,
            console.log("Rapport numero : ", rapport, ".")
         }
         else{
            notification('Erreur, '+ data['message']);
         }
      }); 
   }
   var options = {
      maintainAspectRatio: false,
      scales: {
         y: {
            stacked: true,
            grid: {
               display: true,
               color: "rgba(255,99,132,0.2)"
            },
            ticks: {
               beginAtZero: true
            }
         },
         x: {
            grid: {
               display: false
            }
         },
         yAxes: [{
               scaleLabel: {
               display: true,
               labelString: 'Precipitation in mm'
            }
         }],
         xAxes: [{
            scaleLabel: {
               display: true,
               labelString: 'Month of the Year'
            }
         }]
      },
      layout: {
         padding: 10,
      },
      legend: {
         position: 'bottom',
      },
      title: {
         display: true,
         text: 'Precipitation in Toronto'
      }
   };
   
   function _echart(prix,labels, dgi_name, dgi_prix, prix_estimer){
      var length_data = prix.length;
      console.log("---labels---", labels)
      var basic_columns_options = {
      
      // Setup grid
      grid: {show: false},
      
      // Add tooltip
      tooltip: {
          trigger: 'axis',
      
      },
      
      // Add legend
      legend: {
          data: ['DGI', 'Dexa-reference', 'estimation']
      },
      
      // Enable drag recalculate
      calculable: true,
      
      
      xAxis: {
              type: "category",
              data: labels,
              axisLabel: {
                //interval: 0,
                rotate: 30, //If the label names are too long you can manage this by rotating the label.
                fontSize: 9
              },
            },
      
            yAxis: {
              type: "value",
              //name: "Population 2020 (millions)",
              nameLocation: "center",
              
              nameGap: 30,
              nameTextStyle: {
                align: "center"
              },
              splitNumber: 10
            },
      
      // Horizontal axis
      /*xAxis: [{
          type: 'category',
          data: labels
      }],
      
      // Vertical axis
      yAxis: [{
          type: 'value',
          data: prix,
          axisLabel: {
            formatter: "{value} Dh"
         },
         scale: true,   
            splitLine: {
               show: true
            },
      }],*/
      
      // Add series
      series: [
          {
              name: 'DGI',
              type: 'line',
              data: Array(length_data).fill(dgi_prix),
              itemStyle: {
                  normal: {
                      label: {
                          show: false,
                          textStyle: {
                              fontWeight: 500
                          }
                      }
                  }
              },
              markLine: {
                  data: [{type: 'average', name: 'Average'}]
              }
          },
          
          {
              name: 'references Dexa',
              type: 'bar',
              data: prix,
              itemStyle: {
                  normal: {
                      label: {
                          show: false,
                          textStyle: {
                              fontWeight: 500
                          }
                      }
                  }
              },
              showBackground: true,
                  backgroundStyle: {
                  //color: 'rgba(180, 180, 180, 0.2)'
                  }
              /*markLine: {
                  data: [{type: 'average', name: 'Average'}]
              }*/
          },
          {
              name: 'Prix estimé',
              type: 'line',
              data: Array(length_data).fill(prix_estimer),
              itemStyle: {
                  normal: {
                      label: {
                          show: false,
                          textStyle: {
                              fontWeight: 500
                          }
                      }
                  }
              },
              markLine: {
                  data: [{type: 'average', name: 'Average'}]
              }
          }
      ]
      };
      var basic_columns = echarts.init(document.getElementById("basic_columns"));
      basic_columns.setOption(basic_columns_options);
      }
   
   var myChart = null;
   var labels_sort = []
   function get_approxim_pins(lat,lng){
      var url = 'http://127.0.0.1:8000/rapport/get_approxim_pins/?lat='+lat+'&lng='+lng;
      var prix=[]
      var labels=[]
      var results = []
      map_approximation.off();
      map_approximation.remove();
      const mapDiv = document.getElementById("map_approximation");
      map_approximation = new L.map('map_approximation').setView([parseFloat(lat), parseFloat(lng)], 12)
      L.tileLayer('http://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
         attribution: '© OpenStreetMap contributors'
      }).addTo(map_approximation);
      const resizeObserver = new ResizeObserver(() => {map_approximation.invalidateSize();});//redIcon
      resizeObserver.observe(mapDiv);
      L.marker([parseFloat(lat), parseFloat(lng)],{icon: redIcon()}).addTo(map_approximation);
      fetch(url)
      .then((resp) => resp.json())
      .then(function(data){
         if (myChart != null){
            myChart.destroy();
         }
         pins=data.pins;
         console.log("get_approxim_pins: ", data.pins);
         pins.forEach(element => {
            obj ={'label':element.label,'prix':element.prix_unit}
            results.push(obj);
            L.marker([parseFloat(element.lat), parseFloat(element.lng)],{icon: blueIcon(element.label)}).addTo(map_approximation);
         });
         labels_sort = labels;
         console.log("res: ", results);
         results = _.sortBy(results,"prix");//.reverse();
         console.log("res sort: ", results);
         Object.keys(results).forEach(element => {
            prix.push(results[element].prix);
            labels.push(results[element].label);
         });
         //prix_sort = prix.sort(function(a, b){labels_sort=labels_sort.sort(function(){console.log("a,b: ", labels_sort.indexOf(a),labels_sort.indexOf(b)); labels_sort.indexOf(b.type) - labels_sort.indexOf(a.type);});return b - a;});
         console.log("prix array", prix);
         console.log("label array", labels);
         get_dgi_info(prix, labels, lat, lng, data.prix_estimer);
         $(".prix_estimer").html(data.prix_estimer+" Dh")
      });
   }
   function get_dgi_info(prix, labels, lat, lng, prix_estimer){
      var url = 'http://127.0.0.1:8000/dgi/get_dgi_pin/?lat='+lat+'&lng='+lng;      
      fetch(url)
      .then((resp) => resp.json())
      .then(function(data){
         console.log("dgi pins: ", data.name);
         //chartPrix(prix,labels, data.name, data.prix_unit, prix_estimer);
         _echart(prix,labels, data.name, data.prix_unit, prix_estimer);
      });
   }
   function chartPrix(prix,labels, dgi_name, dgi_prix, prix_estimer){
      var canvas = document.getElementById('mixed-chart');
      const context = canvas.getContext('2d');
      context.clearRect(0, 0, canvas.width, canvas.height);
      var length_data = prix.length;
      var prix_dgi = Array(length_data).fill(dgi_prix);
      var label_dgi = Array(length_data).fill(dgi_name);
      var prix_estimer_array = Array(length_data).fill(prix_estimer)
      console.log("data_dgi.name: ", dgi_name)
      myChart = new Chart(canvas, {
         type: 'bar',
         data: {
            datasets: [{
               label: 'prix unitaire \''+dgi_name+'\' (Dh)',
               data: prix_dgi,
               type: 'line',
               backgroundColor: '#c45850',
               // this dataset is drawn on top
               order: 1,
               borderDash: [10,5],
               borderColor: "#c45850",
               fill:false
            },{
               label: 'prix unitaire estimer (Dh)',
               data: prix_estimer_array,
               type: 'line',
               backgroundColor: 'rgb(255, 99, 132)',
               // this dataset is drawn on top
               order: 1,
               borderDash: [10,5],
               borderColor: "rgb(255, 99, 132)",
               fill:false
            }, {
               label: 'Prix unitaire (Dh)',
               data: prix,
               backgroundColor: 'rgba(75, 192, 192, 0.2)',
               borderColor: 'rgb(75, 192, 192)',
               borderWidth: 1,
               // this dataset is drawn below
               order: 2,
            }],
            labels: labels
         },
         options: {
            legend: {
               position: 'bottom',
            },
            title: {
               display: true,
               text: 'Precipitation in Toronto'
            },
            scales: {
               yAxes: [{
                  scaleLabel: {
                     display: true,
                     labelString: 'Prix unitaire Dh'
                  },
                  ticks: {
                     beginAtZero: true,
                     min: 0
                  },            
               }],
               xAxes: [{
                  scaleLabel: {
                     display: true,
                     labelString: 'Références d\'approximation'
                  }
               }],
            }
         }
      });
   }
</script>